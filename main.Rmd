---
title: "COVID-19"
author: "MK"
date: "16 03 2020"
output: 
  rmarkdown::github_document:
    fig_width: 10
    fig_height: 8
    dev: png 
---

```{r setup, include=FALSE}
library(data.table)
library(tidyverse)
```


## Params

```{r}
url_conf <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv"
```


## Calc

```{r}
build_data <- function(START_CASES_NO = 1, MIN_CASES = 1000, MAX_CASES = Inf, CHART_MAX = 10000, countries_include = c("Poland")){

  data_conf <- 
    fread(url_conf) %>% 
    melt(., id.vars = c(1,2,3,4)) %>% 
    mutate (date = as.Date(variable, format = "%m/%d/%y")) %>% 
    select(-variable) %>% 
    rename(country = `Country/Region`, province = `Province/State`) %>% 
    group_by(country, date) %>% 
    summarize(value = sum(value))
  
  conf_first <- 
    data_conf %>% 
    filter(value > START_CASES_NO) %>% 
    group_by(country) %>% 
    mutate(maxv = max(value)) %>% 
    top_n(-1, wt = date) %>% 
    select(-value) %>% 
    rename(date_first = date)
  
  conf <- 
    data_conf %>% 
    left_join(., conf_first) %>% 
    mutate(days = date-date_first) %>% 
    filter(days >=0) %>% 
    select(-date, -date_first)
  
  conf_filtered <- 
    conf %>% 
    filter((maxv > MIN_CASES & maxv < MAX_CASES & country != "China") | country %in% countries_include) %>%
    filter(value < CHART_MAX) %>%
    mutate(maxv = ifelse(value == maxv, 1, 0))
  
  return(conf_filtered)
}
```


### Plots

```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
countries_include <- c("Poland")
conf_filtered <- build_data(START_CASES_NO = 1, MIN_CASES = 1000, MAX_CASES = Inf, CHART_MAX = Inf, countries_include)

ggplot(conf_filtered, aes(days, log(value), colour = country)) + 
  geom_point() + 
  geom_line() +
  geom_text(data = conf_filtered %>% filter(maxv == 1), aes(label = country, colour = country, x = days, y = log(value)), hjust = -.1) +
  labs(y="Log(Number of cases)", x = "Days from patient 0") +
  labs(title = "1.1 Log(Number of cases), Day 0 = 1 case", subtitle = "countries > 1000 + Poland") +
  labs(caption = "data source: github.com/CSSEGISandData/COVID-19") +
  theme(legend.position="none")
```


```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
countries_include <- c("Poland")
conf_filtered <- build_data(START_CASES_NO = 30, MIN_CASES = 1000, MAX_CASES = Inf, CHART_MAX = Inf, countries_include)


ggplot(conf_filtered, aes(days, log(value), colour = country)) + 
  geom_point() + 
  geom_line() +
  geom_text(data = conf_filtered %>% filter(maxv == 1), aes(label = country, colour = country, x = days, y = log(value)), hjust = -.1) +
  labs(y="Log(Number of cases)", x = "Days from patient 0") +
  labs(title = "1.2 Log(Number of cases), Day 0 = 30 cases", subtitle = "countries > 1000 + Poland") +
  labs(caption = "data source: github.com/CSSEGISandData/COVID-19") +
  theme(legend.position="none")
```


```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
countries_include <- c("Poland")
conf_filtered <- build_data(START_CASES_NO = 1, MIN_CASES = 1000, MAX_CASES = Inf, CHART_MAX = 10000, countries_include)

ggplot(conf_filtered, aes(days, value, colour = country)) + 
  geom_point() + 
  geom_line() +
  geom_text(data = conf_filtered %>% filter(maxv == 1), aes(label = country, colour = country, x = days, y = value), hjust = -.1) +
  labs(y="Number of cases", x = "Days from patient 0") +
  labs(title = "2.1 Number of cases, Day 0 = 1 case", subtitle = "countries > 1000 + Poland, crop at 10000") +
  labs(caption = "data source: github.com/CSSEGISandData/COVID-19")
```


```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
countries_include <- c("Poland")
conf_filtered <- build_data(START_CASES_NO = 30, MIN_CASES = 1000, MAX_CASES = Inf, CHART_MAX = 10000, countries_include)


ggplot(conf_filtered, aes(days, value, colour = country)) + 
  geom_point() + 
  geom_line() +
  geom_text(data = conf_filtered %>% filter(maxv == 1), aes(label = country, colour = country, x = days, y = value), hjust = -.1) +
  labs(y="Number of cases", x = "Days from patient 0") +
  labs(title = "2.2 Number of cases, Day 0 = 30 cases", subtitle = "countries > 1000 + Poland, crop at 10000") +
  labs(caption = "data source: github.com/CSSEGISandData/COVID-19")
```




