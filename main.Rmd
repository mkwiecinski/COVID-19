---
title: "COVID-19"
author: "MK"
date: "16 03 2020"
output: 
  rmarkdown::github_document:
    fig_width: 10
    fig_height: 8
    dev: png 
---

```{r setup, include=FALSE}
library(data.table)
library(tidyverse)
library(broom)
library(lubridate)
```


## Params

```{r}
url_conf <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv"
MIN_DATE <- "2020-03-10"
TODAY    <- "2020-03-20"
TAKE_LOG <- TRUE
```


## Calc

```{r}
build_data <- function(START_CASES_NO = 1, MIN_CASES = 1000, MAX_CASES = Inf, CHART_MAX = 10000, countries_include = c("Poland")){

  population <- fread("API_SP.POP.TOTL_DS2_en_csv_v2_866861.csv", header = TRUE) %>% 
    select(`Country Name`, `2018`) %>% 
    rename(country = `Country Name`, pop = `2018`) %>%
    mutate(pop = pop/1000000)
  
  data_conf <- 
    fread(url_conf) %>% 
    melt(., id.vars = c(1,2,3,4)) %>% 
    mutate (date = as.Date(variable, format = "%m/%d/%y")) %>% 
    select(-variable) %>% 
    rename(country = `Country/Region`, province = `Province/State`) %>% 
    group_by(country, date) %>% 
    summarize(value = sum(value))
  
  conf_first <- 
    data_conf %>% 
    filter(value > START_CASES_NO) %>% 
    group_by(country) %>% 
    mutate(maxv = max(value)) %>% 
    top_n(-1, wt = date) %>% 
    select(-value) %>% 
    rename(date_first = date)
  
  tests <- fread("tests.csv", header = TRUE) %>%
    mutate(date = as.Date(date, format = "%d.%m.%y"))
  
  conf <- 
    data_conf %>% 
    left_join(., conf_first) %>% 
    mutate(days = date-date_first) %>% 
    filter(days >=0) %>% 
    left_join(., population) %>% 
    mutate(value_per_1M = value/pop) %>%
    left_join(., tests) %>%
    mutate(tests_per_1M = tests/pop) %>%
    mutate(cases_per_test = value/tests) %>%
    select(-date, -date_first, -pop)

  conf_filtered <- 
    conf %>% 
    filter((maxv > MIN_CASES & maxv < MAX_CASES & country != "China") | country %in% countries_include) %>%
    filter(value < CHART_MAX) %>%
    mutate(maxv = ifelse(value == maxv, 1, 0))
  
  return(conf_filtered)
}
```


### Plots

```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
countries_include <- c("Poland")
conf_filtered <- build_data(START_CASES_NO = 1, MIN_CASES = 1000, MAX_CASES = Inf, CHART_MAX = Inf, countries_include)

ggplot(conf_filtered, aes(days, log(value), colour = country)) + 
  geom_point() + 
  geom_line() +
  geom_text(data = conf_filtered %>% filter(maxv == 1), aes(label = country, colour = country, x = days, y = log(value)), hjust = -.1) +
  labs(y="Log(Number of cases)", x = "Days from patient 0") +
  labs(title = "1.1 Log(Number of cases), Day 0 = 1 case", subtitle = "countries > 1000 + Poland") +
  labs(caption = "data source: github.com/CSSEGISandData/COVID-19") +
  theme(legend.position="none")
```


```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
countries_include <- c("Poland")
conf_filtered <- build_data(START_CASES_NO = 30, MIN_CASES = 1000, MAX_CASES = Inf, CHART_MAX = Inf, countries_include)


ggplot(conf_filtered, aes(days, log(value), colour = country)) + 
  geom_point() + 
  geom_line() +
  geom_text(data = conf_filtered %>% filter(maxv == 1), aes(label = country, colour = country, x = days, y = log(value)), hjust = -.1) +
  labs(y="Log(Number of cases)", x = "Days from patient 0") +
  labs(title = "1.2 Log(Number of cases), Day 0 = 30 cases", subtitle = "countries > 1000 + Poland") +
  labs(caption = "data source: github.com/CSSEGISandData/COVID-19") +
  theme(legend.position="none")
```


```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
countries_include <- c("Poland")
conf_filtered <- build_data(START_CASES_NO = 1, MIN_CASES = 2000, MAX_CASES = Inf, CHART_MAX = 20000, countries_include)

ggplot(conf_filtered, aes(days, value, colour = country)) + 
  geom_point() + 
  geom_line() +
  geom_text(data = conf_filtered %>% filter(maxv == 1), aes(label = country, colour = country, x = days, y = value), hjust = -.1) +
  labs(y="Number of cases", x = "Days from patient 0") +
  labs(title = "2.1 Number of cases, Day 0 = 1 case", subtitle = "countries > 2000 + Poland, crop at 20000") +
  labs(caption = "data source: github.com/CSSEGISandData/COVID-19")
```


```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
countries_include <- c("Poland")
conf_filtered <- build_data(START_CASES_NO = 30, MIN_CASES = 2000, MAX_CASES = Inf, CHART_MAX = 20000, countries_include)


ggplot(conf_filtered, aes(days, value, colour = country)) + 
  geom_point() + 
  geom_line() +
  geom_text(data = conf_filtered %>% filter(maxv == 1), aes(label = country, colour = country, x = days, y = value), hjust = -.1) +
  labs(y="Number of cases", x = "Days from patient 0") +
  labs(title = "2.2 Number of cases, Day 0 = 30 cases", subtitle = "countries > 2000 + Poland, crop at 20000") +
  labs(caption = "data source: github.com/CSSEGISandData/COVID-19")
```



```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
countries_include <- c("Poland")
conf_filtered <- build_data(START_CASES_NO = 1, MIN_CASES = 1000, MAX_CASES = Inf, CHART_MAX = Inf, countries_include)

ggplot(conf_filtered, aes(days, value_per_1M, colour = country)) + 
  geom_point() + 
  geom_line() +
  geom_text(data = conf_filtered %>% filter(maxv == 1), aes(label = country, colour = country, x = days, y = value_per_1M), hjust = -.1) +
  labs(y="Number of cases per 1M inhabitants", x = "Days from patient 0") +
  labs(title = "3.1 Number of cases per 1M inhabitans, Day 0 = 1 case", subtitle = "countries > 1000 nominal cases + Poland") +
  labs(caption = "data source: github.com/CSSEGISandData/COVID-19")
```


```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
countries_include <- c("Poland")
conf_filtered <- build_data(START_CASES_NO = 30, MIN_CASES = 1000, MAX_CASES = Inf, CHART_MAX = Inf, countries_include)


ggplot(conf_filtered, aes(days, value_per_1M, colour = country)) + 
  geom_point() + 
  geom_line() +
  geom_text(data = conf_filtered %>% filter(maxv == 1), aes(label = country, colour = country, x = days, y = value_per_1M), hjust = -.1) +
  labs(y="Number of cases per 1M inhabitants", x = "Days from patient 0") +
  labs(title = "3.2 Number of cases per 1M inhabitans, Day 0 = 30 cases", subtitle = "countries > 1000 nominal cases + Poland") +
  labs(caption = "data source: github.com/CSSEGISandData/COVID-19")
```

### Rates:

Idea: https://ourworldindata.org/grapher/tests-vs-confirmed-cases-covid-19-per-million

```{r, echo=FALSE, error=FALSE, warning=FALSE, message=FALSE}
countries_include <- c("Poland")
conf_filtered <- build_data(START_CASES_NO = 1, MIN_CASES = 1000, MAX_CASES = Inf, CHART_MAX = Inf, countries_include) %>%
  filter(cases_per_test > 0 & cases_per_test < 250)


ggplot(conf_filtered, aes(tests_per_1M, cases_per_test, colour = country)) + 
  geom_point() + 
  geom_line() +
  geom_text(data = conf_filtered, aes(label = country, colour = country, x = tests_per_1M, y = cases_per_test), vjust = 0, nudge_y = -0.005, size = 3) +
  labs(y="Number of cases per 1 test", x = "Number of tests per 1M inhabitants") +
  labs(title = "4.1 Number of tests per 1M inhabitants vs cases per test", subtitle = "countries > 1000 nominal cases + Poland") +
  labs(caption = "source: github.com/CSSEGISandData/COVID-19, ourworldindata.org/coronavirus-testing-source-data")
```

### Forecast

```{r, echo = FALSE}
countries_include = c("Poland","Austria","Belgium","Denmark","France","Germany","Iran","Italy","Korea, South","Netherlands","Norway","Spain","Sweden","Switzerland","US","United Kingdom")
  
  data_conf <- 
    fread(url_conf) %>% 
    melt(., id.vars = c(1,2,3,4)) %>% 
    mutate (date = as.Date(variable, format = "%m/%d/%y")) %>% 
    select(-variable) %>% 
    rename(country = `Country/Region`, province = `Province/State`) %>% 
    group_by(country, date) %>% 
    summarize(value = sum(value)) %>%
    mutate(log_change = log(value) - log(lag(value, order_by = date))) %>%
    mutate(day0 = min(date)) %>%
    mutate(day_no = date-day0) %>%
    select(-day0)
  
  conf_models <- 
    data_conf %>% 
    filter(value != 0 & log_change != Inf) %>%
    nest(-country) %>%
    mutate(
      fit = map(data, ~lm(log_change ~ day_no, data = .x)),
      tidied = map(fit, tidy)
    ) %>%
    unnest(tidied) %>%
    select(country, estimate, term)
  
  data_chart <- 
    data_conf %>%
    group_by(country) %>%
    complete(date = seq(floor_date(min(date),   "day"), max(date)+3, 1)) %>%
    mutate(max_date = max(date)) %>%
    ungroup(.) %>%
    mutate(max_date = if_else(date == max_date, 1, 0)) %>%
    left_join(conf_models %>% filter(term == "(Intercept)")) %>%
    rename( intercept = estimate) %>%
    select(-term) %>%
    left_join(conf_models %>% filter(term == "day_no")) %>%
    select(-term) %>%
    mutate(day_no = as.integer(day_no, na.rm = TRUE)) %>%
    mutate(fcst  = if_else(is.na(value), 1, 0)) %>%
    mutate (day_no  = if_else(fcst == 1, lag(day_no) + 1, 1.0*day_no)) %>%
    mutate (value_f = if_else(fcst == 1, dplyr::lag(value)  *exp(intercept+day_no*estimate), 1.0*value) ) %>%
    mutate (day_no  = if_else(fcst == 1, lag(day_no) + 1, 1.0*day_no)) %>%
    mutate (value_f = if_else(fcst == 1, dplyr::lag(value_f)*exp(intercept+day_no*estimate), 1.0*value) ) %>%
    mutate (day_no  = if_else(fcst == 1, lag(day_no) + 1, 1.0*day_no)) %>%
    mutate (value_f = if_else(fcst == 1, dplyr::lag(value_f)*exp(intercept+day_no*estimate), 1.0*value) ) %>%
    mutate (value_f =  ifelse(fcst == 1, value_f, NA)) %>%
    select(-log_change, -estimate, -intercept) %>%
    filter(country %in% countries_include) %>%
    filter(date > MIN_DATE) %>%
    mutate(
      label   = if_else(fcst == 0, 1.0*value, round(value_f,0)),
      value   = if(TAKE_LOG) log(value)   else value,
      value_f = if(TAKE_LOG) log(value_f) else value_f
    )
  
  ggplot(      data = data_chart,                       aes(x = date, colour = country ) ) + 
    geom_point(data = data_chart %>% filter(fcst == 0), aes(y = value), alpha = 0.1) + 
    geom_line( data = data_chart %>% filter(fcst == 0), aes(y = value), alpha = 0.1) +
    geom_point(data = data_chart %>% filter(fcst == 1), aes(y = value_f), alpha = 0.9) + 
    geom_line( data = data_chart %>% filter(fcst == 1), aes(y = value_f), alpha = 0.9) +
    geom_text( data = data_chart %>% filter(date == TODAY), aes(label = country, colour = country, x = date, y = value), 
               vjust = 0, nudge_x = 0.5, size = 3) +
    geom_text( data = data_chart %>% filter(fcst == 1), aes(label = label, colour = country, x = date, y = value_f), 
               vjust = 0, nudge_y = 0.15, size = 3) +
    labs(y=paste0(ifelse(TAKE_LOG, "Log of",""),"Number of cases in 3 days"), x = "Date") +
    labs(title = "5.1 Number of cases in 3 days forecast", subtitle = "countries > 1000 + Poland") +
    labs(caption = "data source: github.com/CSSEGISandData/COVID-19") +
    theme(legend.position="none")
```
